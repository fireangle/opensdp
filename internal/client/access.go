package client

import (
	"errors"
	"time"

	"github.com/greenstatic/opensdp/internal/openspa"
	"github.com/greenstatic/opensdp/internal/services"
	log "github.com/sirupsen/logrus"
)

func (c *Client) Access(serv services.Service) error {

	for _, at := range serv.AccessType {
		switch at {
		case services.AccessTypeOpenSPA:
			return AccessOpenSPAService(serv, true, c.OpenSPA.Path, c.OpenSPA.OSPA, c.ClientIp)
		}
	}

	return errors.New("unsupported access type")
}

func AccessOpenSPAService(serv services.Service, continuous bool, openspaPath, ospa string, client_ip string) error {

	var defaultOpenSPAPort uint16 = 22211
	client := openspa.Client{
		openspaPath,
		ospa,
		serv.IP,
		defaultOpenSPAPort,
	}

	for _, port := range serv.ProtoPort {
		req := openspa.Request{
			port.Protocol.String(),
			port.Port,
			port.Port,
		}

		err := client.Send(req, continuous, client_ip)
		if err != nil {
			return err
		}
	}

	return nil
}

func ConcurrentAccessServiceContinuous(c Client, srvs []services.Service) {

	failed := make(chan services.Service, 1)

	for _, srv := range srvs {
		serviceToAccess := srv
		go func() {
			err := c.Access(serviceToAccess)
			if err != nil {
				log.Error(err)
				failed <- serviceToAccess
				return
			}
		}()

		time.Sleep(200) // small delay
	}

	for {
		select {
		case srv := <-failed:
			log.WithField("serviceName", srv.Name).Error("Failed to access service")
		}
	}

}
